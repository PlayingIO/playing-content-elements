<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../nuxeo-ui-elements/nuxeo-slots.html">
<link rel="import" href="../../mostly-elements/mostly-common/mostly-connection.html">
<link rel="import" href="../../mostly-elements/behaviors/mostly-format-behavior.html">

<!--
`playing-document-blob`
@group Nuxeo UI
@element playing-document-blob
-->
<dom-module id="playing-document-blob">
  <template>

    <style>
      :host {
        display: block;
      }

      .row {
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }

      .row .info {
        @apply(--layout-vertical);
        @apply(--layout-flex);
      }

      .row .actions {
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }

      .detail {
        opacity: .5;
      }
    </style>

    <mostly-connection user="{{user}}"></mostly-connection>

    <template is="dom-if" if="[[blob]]">
      <div class="row">
        <div class="info">
          <div><a href="[[blob.data]]">[[blob.name]]</a></div>
          <div class="detail">[[formatSize(blob.length)]]</div>
        </div>
        <div class="actions">
          <nuxeo-slot slot="BLOB_ACTIONS" model="[[actionContext]]"></nuxeo-slot>
        </div>
      </div>
    </template>

  </template>

</dom-module>

<script>
  Polymer({
    is: 'playing-document-blob',
    behaviors: [Mostly.I18nBehavior, Mostly.FormatBehavior],
    properties: {
      user: Object,
      document: Object,
      xpath: {
        type: String,
        value: 'file:content'
      },
      blob: Object,
      actionContext: Object
    },

    observers: [
      '_update(user, document, xpath)'
    ],

    _update: function(user, document, xpath) {
      this.blob = document && this._deepFind(document.properties, xpath);
      this.actionContext = {user: this.user, document: this.document, blob: this.blob, xpath: this.xpath};
    },

    _deepFind: function(obj, props) {
      for (var i = 0, path = props.split('/'), len = path.length; i < len; i++) {
        if (!obj || obj === []) {
          break;
        }
        obj = obj[path[i]];
      }
      return obj;
    }

  });
</script>
